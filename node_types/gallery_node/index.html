<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: #eee;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Viewer */
        #viewer {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #current-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        #viewer:hover .nav-btn {
            opacity: 1;
        }

        #prevBtn {
            left: 10px;
        }

        #nextBtn {
            right: 10px;
        }

        /* Controls */
        #toolbar {
            height: 36px;
            background: #222;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: #333;
            border: 1px solid #444;
            color: #ddd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        button {
            background: #444;
            border: none;
            color: #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        button:hover {
            background: #555;
            color: white;
        }

        button.active {
            background: #007bff;
            color: white;
        }

        #counter {
            font-size: 10px;
            color: #666;
            min-width: 30px;
            text-align: center;
        }

        /* Empty State */
        .empty-state {
            color: #666;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div id="viewer">
        <div class="empty-state" id="emptyState">
            <i class="fas fa-images fa-2x"></i>
            <div>Add URL below</div>
        </div>
        <img id="current-image" style="display: none;">

        <button id="prevBtn" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
        <button id="nextBtn" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div id="toolbar">
        <input type="text" id="urlInput" placeholder="Image URL...">
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
        <button id="addBtn" title="Add URL"><i class="fas fa-plus"></i></button>
        <button id="uploadBtn" title="Upload Files"><i class="fas fa-upload"></i></button>
        <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>
        <button id="playBtn" title="Slideshow"><i class="fas fa-play"></i></button>
        <button id="clearBtn" title="Clear All"><i class="fas fa-trash"></i></button>
        <div id="counter">0/0</div>
    </div>

    <script src="../../js/MosaicNode.js"></script>
    <script>
        // Utils
        const el = (id) => document.getElementById(id);

        // State
        let images = []; // Array of URL strings (Base64 or Remote)
        let currentIndex = 0;
        let isPlaying = false;
        let slideInterval = null;

        // UI
        const imgEl = el('current-image');
        const emptyState = el('emptyState');
        const urlInput = el('urlInput');
        const viewer = el('viewer');

        // Logic

        function render() {
            if (images.length === 0) {
                imgEl.style.display = 'none';
                emptyState.style.display = 'flex';
                // Show D&D hint
                emptyState.querySelector('div').innerText = "Add URL or Drop Images";
                el('counter').innerText = '0/0';
                window.Mosaic.send({ type: 'text', value: 'Gallery Empty' });
                return;
            }

            imgEl.style.display = 'block';
            emptyState.style.display = 'none';
            imgEl.src = images[currentIndex];
            el('counter').innerText = `${currentIndex + 1}/${images.length}`;

            // Sync with Host Canvas
            window.Mosaic.send({
                type: 'image',
                value: images[currentIndex],
                index: currentIndex,
                total: images.length
            });
        }

        function addImage(url) {
            if (!url) return;
            images.push(url);
            currentIndex = images.length - 1; // Jump to new
            save();
            render();
        }

        function handleAddUrl() {
            const url = urlInput.value.trim();
            if (url) {
                addImage(url);
                urlInput.value = '';
            }
        }

        // --- FILE UPLOAD LOGIC ---
        function handleFiles(files) {
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    addImage(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        }

        el('uploadBtn').addEventListener('click', () => {
            el('fileInput').click();
        });

        el('fileInput').addEventListener('change', (e) => {
            handleFiles(e.target.files);
            // Reset input so same file can be selected again if needed
            e.target.value = '';
        });

        // --- DRAG AND DROP ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            viewer.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        viewer.addEventListener('dragenter', () => viewer.style.background = '#222');
        viewer.addEventListener('dragleave', () => viewer.style.background = '#000');

        viewer.addEventListener('drop', (e) => {
            viewer.style.background = '#000';
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });

        function next() {
            if (images.length === 0) return;
            currentIndex = (currentIndex + 1) % images.length;
            render();
            // Optional: Save index to persist state during session
            save();
        }

        function prev() {
            if (images.length === 0) return;
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            render();
            save();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = el('playBtn');

            if (isPlaying) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                slideInterval = setInterval(next, 3000); // 3 seconds
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-play"></i>';
                clearInterval(slideInterval);
            }
        }

        function clearAll() {
            if (confirm('Clear all images?')) {
                images = [];
                currentIndex = 0;
                if (isPlaying) togglePlay();
                render();
                save();
            }
        }

        function save() {
            window.Mosaic.saveData({
                images: images,
                currentIndex: currentIndex
            });
        }

        // Listeners
        el('addBtn').addEventListener('click', handleAddUrl);
        el('nextBtn').addEventListener('click', next);
        el('prevBtn').addEventListener('click', prev);
        el('playBtn').addEventListener('click', togglePlay);
        el('clearBtn').addEventListener('click', clearAll);

        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAddUrl();
        });

        // Init
        window.Mosaic.onDataLoaded = (data) => {
            if (data && data.images) {
                images = data.images;
                if (data.currentIndex !== undefined) {
                    currentIndex = data.currentIndex;
                }
                // Validate index
                if (currentIndex >= images.length) currentIndex = 0;

                render();
            }
        };

        // Respond to output requests (e.g. from new connections)
        window.Mosaic.on('request_output', () => {
            render();
        });

    </script>
</body>

</html>