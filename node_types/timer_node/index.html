<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #252525;
            color: #eee;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Digital Clock Display */
        #display {
            font-size: 32px;
            font-family: 'Courier New', monospace;
            text-align: center;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            margin-bottom: 10px;
            background: #111;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        #display.expired {
            color: #f00;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        button {
            flex: 1;
            background: #444;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        button:hover {
            background: #555;
        }

        button:active {
            background: #333;
        }

        button.primary {
            background: #007bff;
        }

        button.primary:hover {
            background: #0056b3;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #a71d2a;
        }

        /* Settings */
        .settings {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 12px;
            color: #aaa;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            width: 60px;
        }

        input,
        select {
            flex: 1;
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 4px;
            border-radius: 3px;
        }

        .tab-group {
            display: flex;
            margin-bottom: 10px;
            background: #333;
            border-radius: 4px;
            padding: 2px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 4px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .tab.active {
            background: #555;
            color: white;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="display">00:00</div>

    <div class="controls">
        <button id="startBtn" class="primary"><i class="fas fa-play"></i> <span
                data-tr="timerStart">Start</span></button>
        <button id="resetBtn" class="danger"><i class="fas fa-undo"></i> <span
                data-tr="timerReset">Reset</span></button>
    </div>

    <div class="tab-group">
        <div class="tab active" data-mode="countdown" data-tr="timerCountdown">Countdown</div>
        <div class="tab" data-mode="stopwatch" data-tr="timerStopwatch">Stopwatch</div>
        <div class="tab" data-mode="loop" data-tr="timerLoop">Loop</div>
    </div>

    <div class="settings">
        <!-- Countdown Settings -->
        <div id="countdown-settings">
            <div class="row">
                <label data-tr="timerMinutes">Minutes</label>
                <input type="number" id="minutes" value="5" min="0">
            </div>
            <div class="row">
                <label data-tr="timerSeconds">Seconds</label>
                <input type="number" id="seconds" value="0" min="0" max="59">
            </div>
        </div>

        <!-- Loop Settings -->
        <div id="loop-settings" class="hidden">
            <div class="row">
                <label data-tr="timerEvery">Every</label>
                <input type="number" id="loopInterval" value="10" min="1">
                <select id="loopUnit">
                    <option value="sec" data-tr="timerLoopSecond">Seconds</option>
                    <option value="min" data-tr="timerLoopMinute">Minutes</option>
                    <option value="hour" data-tr="timerLoopHour">Hours</option>
                </select>
            </div>
            <div style="font-size: 10px; margin-top: 4px;" data-tr="timerLoopHelp">Fires signal on every loop.</div>
        </div>

        <div class="row">
            <input type="checkbox" id="autoStart" style="flex: 0 0 auto;">
            <span data-tr="timerAutoStart">Auto-start on load</span>
        </div>
    </div>

    <script src="../../js/MosaicNode.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        // UI Elements
        const display = document.getElementById('display');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const inputs = {
            minutes: document.getElementById('minutes'),
            seconds: document.getElementById('seconds'),
            loopInterval: document.getElementById('loopInterval'),
            loopUnit: document.getElementById('loopUnit'),
            autoStart: document.getElementById('autoStart')
        };
        const tabs = document.querySelectorAll('.tab');
        const panels = {
            countdown: document.getElementById('countdown-settings'),
            loop: document.getElementById('loop-settings')
        };

        // State
        let state = {
            mode: 'countdown', // countdown, stopwatch, loop
            isRunning: false,
            startTime: null,
            duration: 5 * 60, // seconds
            elapsed: 0,
            settings: {
                minutes: 5,
                seconds: 0,
                loopInterval: 10,
                loopUnit: 'sec',
                autoStart: false
            }
        };

        // === SELF-CONTAINED TRANSLATIONS ===
        const translations = {
            en: {
                start: "Start",
                pause: "Pause",
                reset: "Reset",
                minutes: "Minutes",
                seconds: "Seconds",
                countdown: "Countdown",
                stopwatch: "Stopwatch",
                loop: "Loop",
                every: "Every",
                autoStart: "Auto-start on load",
                loopSecond: "Seconds",
                loopMinute: "Minutes",
                loopHour: "Hours",
                loopHelp: "Fires signal on every loop."
            },
            tr: {
                start: "Başlat",
                pause: "Duraklat",
                reset: "Sıfırla",
                minutes: "Dakika",
                seconds: "Saniye",
                countdown: "Geri Sayım",
                stopwatch: "Kronometre",
                loop: "Döngü",
                every: "Her",
                autoStart: "Yüklendiğinde otomatik başlat",
                loopSecond: "Saniye",
                loopMinute: "Dakika",
                loopHour: "Saat",
                loopHelp: "Her döngüde sinyal gönder."
            },
            es: {
                start: "Iniciar",
                pause: "Pausar",
                reset: "Reiniciar",
                minutes: "Minutos",
                seconds: "Segundos",
                countdown: "Cuenta Regresiva",
                stopwatch: "Cronómetro",
                loop: "Bucle",
                every: "Cada",
                autoStart: "Inicio automático al cargar",
                loopSecond: "Segundos",
                loopMinute: "Minutos",
                loopHour: "Horas",
                loopHelp: "Envía señal en cada bucle."
            },
            fr: {
                start: "Démarrer",
                pause: "Pause",
                reset: "Réinitialiser",
                minutes: "Minutes",
                seconds: "Secondes",
                countdown: "Compte à rebours",
                stopwatch: "Chronomètre",
                loop: "Boucle",
                every: "Chaque",
                autoStart: "Démarrage auto",
                loopSecond: "Secondes",
                loopMinute: "Minutes",
                loopHour: "Heures",
                loopHelp: "Signale à chaque boucle."
            },
            de: {
                start: "Starten",
                pause: "Pause",
                reset: "Zurücksetzen",
                minutes: "Minuten",
                seconds: "Sekunden",
                countdown: "Countdown",
                stopwatch: "Stoppuhr",
                loop: "Schleife",
                every: "Jede",
                autoStart: "Auto-Start beim Laden",
                loopSecond: "Sekunden",
                loopMinute: "Minuten",
                loopHour: "Stunden",
                loopHelp: "Sendet Signal bei jedem Durchlauf."
            }
        };

        let currentLanguage = 'en';

        // Helper function to get translated text
        function t(key) {
            return translations[currentLanguage]?.[key] || translations.en[key] || key;
        }

        // Apply translations to UI elements
        function applyTranslations() {
            document.querySelectorAll('[data-tr]').forEach(el => {
                const key = el.getAttribute('data-tr');
                const translated = t(key);
                el.textContent = translated;
            });
        }

        // === STATE & TIMER LOGIC ===
        let timerId = null;
        // Removed duplicate translations declaration

        // --- Core Logic ---

        function updateDisplay() {
            let text = "00:00";
            let remaining = 0;

            if (state.mode === 'countdown') {
                remaining = Math.max(0, state.duration - state.elapsed);
                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                text = `${pad(m)}:${pad(s)}`;
            }
            else if (state.mode === 'stopwatch') {
                const m = Math.floor(state.elapsed / 60);
                const s = state.elapsed % 60;
                const ms = Math.floor((state.elapsed % 1) * 10); // deciseconds if needed?
                text = `${pad(m)}:${pad(s)}`;
            }
            else if (state.mode === 'loop') {
                // Calculate remaining to next loop
                let totalSeconds = getLoopSeconds();
                remaining = totalSeconds - (state.elapsed % totalSeconds);
                if (remaining === totalSeconds) remaining = 0; // Handle exact boundary

                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                text = `${pad(m)}:${pad(s)}`;
            }

            display.innerText = text;
            if (remaining === 0 && state.mode === 'countdown' && state.isRunning) {
                display.classList.add('expired');
            } else {
                display.classList.remove('expired');
            }

            // Sync with Host (Canvas)
            window.Mosaic.send({ type: 'text', value: text });
        }

        function tick() {
            if (!state.isRunning) return;

            state.elapsed += 1;

            if (state.mode === 'countdown') {
                if (state.elapsed >= state.duration) {
                    stop();
                    playSound();
                    window.Mosaic.send({ type: 'signal', event: 'complete' });
                    display.classList.add('expired');
                }
            }
            else if (state.mode === 'loop') {
                const loopSecs = getLoopSeconds();
                if (state.elapsed > 0 && state.elapsed % loopSecs === 0) {
                    window.Mosaic.send({ type: 'signal', event: 'tick' });
                    flashDisplay();
                }
            }

            updateDisplay();
            saveState(); // Frequent save? Maybe optimize.
        }

        function start() {
            if (state.isRunning) return;
            state.isRunning = true;
            display.classList.remove('expired');

            // If countdown finished, reset first
            if (state.mode === 'countdown' && state.elapsed >= state.duration) {
                state.elapsed = 0;
            }

            timerId = setInterval(tick, 1000);
            const pauseText = `<i class="fas fa-pause"></i> ${t('timerPause', 'Pause')}`;
            startBtn.innerHTML = pauseText;

            updateDisplay();
            saveState();
        }

        function stop() {
            state.isRunning = false;
            if (timerId) clearInterval(timerId);
            const startText = `<i class="fas fa-play"></i> ${t('timerStart', 'Start')}`;
            startBtn.innerHTML = startText;
            saveState();
        }

        function reset() {
            stop();
            state.elapsed = 0;
            display.classList.remove('expired');
            updateDisplay();
            saveState();
        }

        function pad(n) { return n < 10 ? '0' + n : n; }

        function getLoopSeconds() {
            const val = parseInt(state.settings.loopInterval);
            const unit = state.settings.loopUnit;
            if (unit === 'sec') return val;
            if (unit === 'min') return val * 60;
            if (unit === 'hour') return val * 3600;
            return 10;
        }

        function flashDisplay() {
            display.style.backgroundColor = '#333';
            setTimeout(() => display.style.backgroundColor = '#111', 200);
        }

        function playSound() {
            // Beep logic (needs user interaction first usually, but in iframe it might work)
        }

        function saveState() {
            window.Mosaic.saveData(state);
        }

        // --- Interaction ---

        startBtn.addEventListener('click', () => {
            if (state.isRunning) stop(); else start();
        });

        resetBtn.addEventListener('click', reset);

        // Inputs
        inputs.minutes.addEventListener('change', () => {
            state.settings.minutes = parseInt(inputs.minutes.value);
            state.duration = (state.settings.minutes * 60) + state.settings.seconds;
            updateDisplay(); saveState();
        });
        inputs.seconds.addEventListener('change', () => {
            state.settings.seconds = parseInt(inputs.seconds.value);
            state.duration = (state.settings.minutes * 60) + state.settings.seconds;
            updateDisplay(); saveState();
        });
        inputs.loopInterval.addEventListener('change', () => {
            state.settings.loopInterval = parseInt(inputs.loopInterval.value);
            updateDisplay(); saveState();
        });
        inputs.loopUnit.addEventListener('change', () => {
            state.settings.loopUnit = inputs.loopUnit.value;
            updateDisplay(); saveState();
        });
        inputs.autoStart.addEventListener('change', () => {
            state.settings.autoStart = inputs.autoStart.checked;
            saveState();
        });

        // Tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const mode = tab.dataset.mode;
                state.mode = mode;

                // Toggle panels
                if (mode === 'countdown') {
                    panels.countdown.classList.remove('hidden');
                    panels.loop.classList.add('hidden');
                } else if (mode === 'loop') {
                    panels.countdown.classList.add('hidden');
                    panels.loop.classList.remove('hidden');
                } else {
                    panels.countdown.classList.add('hidden');
                    panels.loop.classList.add('hidden');
                }

                reset();
            });
        });

        // --- Initialization ---

        window.Mosaic.onDataLoaded = (data) => {
            // Get language and apply translations
            if (data && data.language) {
                currentLanguage = data.language;
                applyTranslations();
            }

            if (data && data.mode) {
                state = data;

                // Restore inputs
                inputs.minutes.value = state.settings.minutes || 5;
                inputs.seconds.value = state.settings.seconds || 0;
                inputs.loopInterval.value = state.settings.loopInterval || 10;
                inputs.loopUnit.value = state.settings.loopUnit || 'sec';
                inputs.autoStart.checked = state.settings.autoStart || false;

                // Activate Tab
                tabs.forEach(t => {
                    if (t.dataset.mode === state.mode) t.click();
                });

                // Auto Start?
                if (state.settings.autoStart && !state.isRunning) {
                    start();
                } else if (state.isRunning) {
                    // Resume if it was running?
                    // Careful with elapsed time diff. For now just resume tick.
                    state.isRunning = false; // logic requires start() to set to true
                    start();
                }

                updateDisplay();
            }
        };

    </script>
</body>

</html>