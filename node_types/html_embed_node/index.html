<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            background: #1e1e1e;
            color: #ddd;
            font-family: monospace;
            overflow: hidden;
        }

        #toolbar {
            height: 30px;
            background: #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #555;
        }

        #container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #code-input {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #ccc;
            border: none;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-family: monospace;
            display: block;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: none;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button id="run-btn"><i class="fas fa-play"></i> Run</button>
        <button id="edit-btn" class="secondary hidden"><i class="fas fa-edit"></i> Edit</button>
    </div>

    <div id="container">
        <textarea id="code-input"
            placeholder="<h1>Hello World</h1>\n<script>\n  console.log('Test');\n</script>"></textarea>
        <iframe id="preview-frame"></iframe>
    </div>

    <!-- SDK -->
    <script src="../../js/MosaicNode.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        const codeInput = document.getElementById('code-input');
        const previewFrame = document.getElementById('preview-frame');
        const runBtn = document.getElementById('run-btn');
        const editBtn = document.getElementById('edit-btn');

        // State
        let currentCode = "";
        let isRunning = false;

        // Toggle Mode
        runBtn.addEventListener('click', () => {
            currentCode = codeInput.value;
            isRunning = true;
            window.Mosaic.saveData({ content: currentCode, isRunning: true });
            runCode();
        });

        editBtn.addEventListener('click', () => {
            isRunning = false;
            window.Mosaic.saveData({ content: codeInput.value, isRunning: false });
            editCode();
        });

        function runCode() {
            // Render
            previewFrame.srcdoc = currentCode;

            // UI Toggle
            codeInput.classList.add('hidden');
            previewFrame.classList.remove('hidden');
            previewFrame.style.display = 'block';

            runBtn.classList.add('hidden');
            editBtn.classList.remove('hidden');

            // Broadcast Output
            window.Mosaic.send({ type: 'html', value: currentCode });
            console.log('Sending output type: html');
        }

        function editCode() {
            // UI Toggle
            previewFrame.classList.add('hidden');
            previewFrame.style.display = 'none';
            codeInput.classList.remove('hidden');

            editBtn.classList.add('hidden');
            runBtn.classList.remove('hidden');
        }

        // Mosaic Integration
        window.Mosaic.onDataLoaded = (data) => {
            if (data.content) {
                codeInput.value = data.content;
                currentCode = data.content;
                // Standard: Prime cache / Send initial state
                window.Mosaic.send({ type: 'html', value: currentCode });
            }
            if (data.isRunning) {
                isRunning = true;
                runCode();
            }
        };

        // Inputs save automatically on change
        codeInput.addEventListener('input', () => {
            // Don't save isRunning here, just content. 
            // If we are editing, isRunning must be false anyway.
            window.Mosaic.saveData({ content: codeInput.value, isRunning: isRunning });
        });

    </script>
</body>

</html>